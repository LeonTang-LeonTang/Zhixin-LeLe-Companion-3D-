import React, { useEffect, useState, useRef } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { getCurrentWindow } from '@tauri-apps/api/window'
import { EnterpriseManager, defaultConfig } from './enterprise/EnterpriseManager'
import { TencentCloudADP, defaultADPConfig } from './enterprise/TencentCloudADP'
import './App.css'

// å¯¼å…¥å›¾ç‰‡èµ„æº
import pandaNormal from './assets/images/panda-normal.png'
import pandaWalking from './assets/images/panda-walking.png'
import pandaYawning from './assets/images/panda-yawning.png'
import pandaSleeping from './assets/images/panda-sleeping.png'
import pandaWorking from './assets/images/panda-working.png'
import pandaEating from './assets/images/panda-eating.png'

// ç†ŠçŒ«çŠ¶æ€ç±»å‹
type PandaState = 'normal' | 'walking' | 'yawning' | 'sleeping' | 'working' | 'eating' | 'happy' | 'thinking' | 'excited'

// ä¼ä¸šåŠŸèƒ½ç±»å‹
type EnterpriseFunction = 'chat' | 'email' | 'project' | 'data' | 'finance' | 'hr' | 'crm' | 'supply' | 'settings'

// å­—å¹•æ¶ˆæ¯ç±»å‹
interface SubtitleMessage {
  id: string
  text: string
  duration: number
  type: 'normal' | 'enterprise' | 'mood'
}

function App() {
  const [pandaState, setPandaState] = useState<PandaState>('normal')
  const [isDragging, setIsDragging] = useState(false)
  const [showContextMenu, setShowContextMenu] = useState(false)
  const [showFunctionWindow, setShowFunctionWindow] = useState<EnterpriseFunction | null>(null)
  const [position, setPosition] = useState({ x: 50, y: 50 })
  const [isAnimating, setIsAnimating] = useState(false)
  const [currentSubtitle, setCurrentSubtitle] = useState<SubtitleMessage | null>(null)
  const [mood, setMood] = useState<'happy' | 'normal' | 'tired' | 'excited'>('normal')
  const [isAutoChanging, setIsAutoChanging] = useState(true)
  const [enterpriseManager] = useState(() => new EnterpriseManager(defaultConfig))
  const [adpClient] = useState(() => new TencentCloudADP(defaultADPConfig))
  const [chatMessages, setChatMessages] = useState<Array<{id: string, text: string, type: 'user' | 'ai', timestamp: Date}>>([])
  const [chatInput, setChatInput] = useState('')
  
  const dragRef = useRef<HTMLDivElement>(null)
  const autoChangeInterval = useRef<NodeJS.Timeout | null>(null)
  const subtitleTimeout = useRef<NodeJS.Timeout | null>(null)
  const longPressTimer = useRef<NodeJS.Timeout | null>(null)
  const lastClickTime = useRef<number>(0)
  const randomMoveInterval = useRef<NodeJS.Timeout | null>(null)
  const dragStart = useRef<{ x: number, y: number }>({ x: 0, y: 0 })
  const [screenSize, setScreenSize] = useState({ width: 500, height: 500 })

  // ç†ŠçŒ«çŠ¶æ€é…ç½®
  const pandaStates = {
    normal: { image: pandaNormal, name: 'æ­£å¸¸' },
    walking: { image: pandaWalking, name: 'èµ°è·¯' },
    yawning: { image: pandaYawning, name: 'æ‰“å“ˆæ¬ ' },
    sleeping: { image: pandaSleeping, name: 'ç¡è§‰' },
    working: { image: pandaWorking, name: 'å·¥ä½œ' },
    eating: { image: pandaEating, name: 'åƒé¥­' },
    happy: { image: pandaNormal, name: 'å¼€å¿ƒ' },
    thinking: { image: pandaNormal, name: 'æ€è€ƒ' },
    excited: { image: pandaNormal, name: 'å…´å¥‹' }
  }

  // ä¼ä¸šåŠŸèƒ½é…ç½®
  const enterpriseFunctions = {
    chat: { 
      icon: 'ğŸ’¬', 
      name: 'AIæ™ºèƒ½å¯¹è¯', 
      description: 'åŸºäºè…¾è®¯äº‘LLMçš„æ™ºèƒ½åŠ©æ‰‹ï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€å¯¹è¯å’Œä¸šåŠ¡å’¨è¯¢' 
    },
    email: { 
      icon: 'ï¿½ï¿½', 
      name: 'é‚®ä»¶ç®¡ç†', 
      description: 'æ™ºèƒ½é‚®ä»¶å¤„ç†ï¼Œè‡ªåŠ¨åˆ†ç±»ã€å›å¤å’Œä¼˜å…ˆçº§ç®¡ç†' 
    },
    project: { 
      icon: 'ğŸ“‹', 
      name: 'é¡¹ç›®ç®¡ç†', 
      description: 'ä»»åŠ¡è·Ÿè¸ªã€è¿›åº¦ç›‘æ§å’Œå›¢é˜Ÿåä½œç®¡ç†' 
    },
    data: { 
      icon: 'ğŸ“Š', 
      name: 'æ•°æ®åˆ†æ', 
      description: 'å®æ—¶æ•°æ®åˆ†æå’Œå¯è§†åŒ–ï¼Œæ”¯æŒå¤šç»´åº¦æŠ¥è¡¨' 
    },
    finance: { 
      icon: 'ğŸ’°', 
      name: 'è´¢åŠ¡ç®¡ç†', 
      description: 'è´¢åŠ¡åˆ†æã€é¢„ç®—ç®¡ç†å’Œæˆæœ¬æ§åˆ¶' 
    },
    hr: { 
      icon: 'ğŸ‘¥', 
      name: 'äººåŠ›èµ„æº', 
      description: 'æ‹›è˜ç®¡ç†ã€ç»©æ•ˆè¯„ä¼°å’Œå‘˜å·¥å‘å±•' 
    },
    crm: { 
      icon: 'ï¿½ï¿½', 
      name: 'å®¢æˆ·ç®¡ç†', 
      description: 'å®¢æˆ·å…³ç³»ç®¡ç†ã€é”€å”®è·Ÿè¸ªå’Œå•†æœºåˆ†æ' 
    },
    supply: { 
      icon: 'ğŸ“¦', 
      name: 'ä¾›åº”é“¾', 
      description: 'åº“å­˜ç®¡ç†ã€ä¾›åº”å•†ç®¡ç†å’Œç‰©æµä¼˜åŒ–' 
    },
    settings: { 
      icon: 'âš™ï¸', 
      name: 'ç³»ç»Ÿè®¾ç½®', 
      description: 'ä¸ªæ€§åŒ–é…ç½®ã€æƒé™ç®¡ç†å’Œç³»ç»Ÿä¼˜åŒ–' 
    }
  }

  // æ˜¾ç¤ºå­—å¹•
  const showSubtitle = (message: SubtitleMessage) => {
    setCurrentSubtitle(message)
    if (subtitleTimeout.current) {
      clearTimeout(subtitleTimeout.current)
    }
    subtitleTimeout.current = setTimeout(() => {
      setCurrentSubtitle(null)
    }, message.duration)
  }

  // è‡ªåŠ¨çŠ¶æ€å˜åŒ–
  const autoChangeState = () => {
    if (isDragging) return
    
    const states: PandaState[] = ['normal', 'walking', 'yawning', 'sleeping', 'working', 'eating']
    const currentIndex = states.indexOf(pandaState)
    const nextIndex = (currentIndex + 1) % states.length
    const nextState = states[nextIndex]
    
    setPandaState(nextState)
    setIsAnimating(true)
    
    setTimeout(() => setIsAnimating(false), 600)
    
    showSubtitle({
      id: Date.now().toString(),
      text: `æˆ‘ç°åœ¨æ˜¯${pandaStates[nextState].name}çŠ¶æ€`,
      duration: 2000,
      type: 'normal'
    })
  }

  // éšæœºç§»åŠ¨ç†ŠçŒ«
  const randomMovePanda = () => {
    if (isDragging) return
    
    const newX = Math.random() * (screenSize.width - 150)
    const newY = Math.random() * (screenSize.height - 150)
    setPosition({ x: newX, y: newY })
    
    showSubtitle({
      id: Date.now().toString(),
      text: 'æˆ‘æ¢ä¸ªä½ç½®å¾…ç€...',
      duration: 2000,
      type: 'mood'
    })
  }

  // é¼ æ ‡æŒ‰ä¸‹å¼€å§‹æ‹–æ‹½
  const handleMouseDown = (e: React.MouseEvent) => {
    e.preventDefault()
    dragStart.current = { x: e.clientX - position.x, y: e.clientY - position.y }
    setIsDragging(true)
    setShowContextMenu(false)
    setShowFunctionWindow(null)
  }

  // é¼ æ ‡ç§»åŠ¨æ‹–æ‹½
  const handleMouseMove = (e: React.MouseEvent) => {
    if (!isDragging) return
    
    const newX = Math.max(0, Math.min(e.clientX - dragStart.current.x, screenSize.width - 150))
    const newY = Math.max(0, Math.min(e.clientY - dragStart.current.y, screenSize.height - 150))
    setPosition({ x: newX, y: newY })
  }

  // é¼ æ ‡é‡Šæ”¾ç»“æŸæ‹–æ‹½
  const handleMouseUp = () => {
    setIsDragging(false)
  }

  // å³é”®èœå•
  const handleContextMenu = (e: React.MouseEvent) => {
    e.preventDefault()
    setShowContextMenu(!showContextMenu)
    setShowFunctionWindow(null)
  }

  // ç‚¹å‡»ç†ŠçŒ«
  const handleClick = (e: React.MouseEvent) => {
    e.preventDefault()
    const now = Date.now()
    
    if (now - lastClickTime.current < 300) {
      // åŒå‡»æ‰“å¼€èŠå¤©
      openEnterpriseFunction('chat')
    } else {
      // å•å‡»åˆ‡æ¢çŠ¶æ€
      const states: PandaState[] = ['normal', 'walking', 'yawning', 'sleeping', 'working', 'eating']
      const currentIndex = states.indexOf(pandaState)
      const nextIndex = (currentIndex + 1) % states.length
      const nextState = states[nextIndex]
      
      setPandaState(nextState)
      setIsAnimating(true)
      
      setTimeout(() => setIsAnimating(false), 600)
      
      showSubtitle({
        id: Date.now().toString(),
        text: `æˆ‘ç°åœ¨æ˜¯${pandaStates[nextState].name}çŠ¶æ€`,
        duration: 2000,
        type: 'normal'
      })
    }
    
    lastClickTime.current = now
  }

  // æ‰“å¼€ä¼ä¸šåŠŸèƒ½
  const openEnterpriseFunction = (func: EnterpriseFunction) => {
    setShowFunctionWindow(func)
    setShowContextMenu(false)
    
    showSubtitle({
      id: Date.now().toString(),
      text: `æ‰“å¼€${enterpriseFunctions[func].name}`,
      duration: 2000,
      type: 'enterprise'
    })
  }

  // æ”¹å˜å¿ƒæƒ…
  const changeMood = (newMood: 'happy' | 'normal' | 'tired' | 'excited') => {
    setMood(newMood)
    setShowContextMenu(false)
    
    const moodTexts = {
      happy: 'æˆ‘å¾ˆå¼€å¿ƒï¼',
      normal: 'æˆ‘å¾ˆå¹³é™',
      tired: 'æˆ‘æœ‰ç‚¹ç´¯äº†...',
      excited: 'æˆ‘å¾ˆå…´å¥‹ï¼'
    }
    
    showSubtitle({
      id: Date.now().toString(),
      text: moodTexts[newMood],
      duration: 2000,
      type: 'mood'
    })
  }

  // åˆ‡æ¢è‡ªåŠ¨çŠ¶æ€å˜åŒ–
  const toggleAutoChange = () => {
    setIsAutoChanging(!isAutoChanging)
    setShowContextMenu(false)
    
    showSubtitle({
      id: Date.now().toString(),
      text: isAutoChanging ? 'åœæ­¢è‡ªåŠ¨å˜åŒ–' : 'å¼€å§‹è‡ªåŠ¨å˜åŒ–',
      duration: 2000,
      type: 'normal'
    })
  }

  // å‘é€èŠå¤©æ¶ˆæ¯
  const sendChatMessage = async () => {
    if (!chatInput.trim()) return
    
    const userMessage = {
      id: Date.now().toString(),
      text: chatInput,
      type: 'user' as const,
      timestamp: new Date()
    }
    
    setChatMessages(prev => [...prev, userMessage])
    setChatInput('')
    
    try {
      // ä½¿ç”¨è…¾è®¯äº‘ADPè¿›è¡ŒAIå¯¹è¯
      const response = await adpClient.chat({
        model: 'gpt-3.5-turbo',
        messages: [
          { role: 'system', content: 'ä½ æ˜¯å°ç«¹å­ï¼Œä¸€ä¸ªå¯çˆ±çš„AIæ¡Œé¢åŠ©æ‰‹ï¼Œä¸“é—¨å¸®åŠ©ä¼ä¸šç”¨æˆ·è§£å†³å„ç§ä¸šåŠ¡é—®é¢˜ã€‚' },
          { role: 'user', content: chatInput }
        ],
        temperature: 0.7,
        max_tokens: 500
      })
      
      const aiMessage = {
        id: (Date.now() + 1).toString(),
        text: response.choices[0].message.content,
        type: 'ai' as const,
        timestamp: new Date()
      }
      
      setChatMessages(prev => [...prev, aiMessage])
    } catch (error) {
      console.error('AI chat failed:', error)
      const errorMessage = {
        id: (Date.now() + 1).toString(),
        text: 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›å¤ï¼Œè¯·ç¨åå†è¯•ã€‚',
        type: 'ai' as const,
        timestamp: new Date()
      }
      setChatMessages(prev => [...prev, errorMessage])
    }
  }

  // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      setShowContextMenu(false)
    }
    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  // è‡ªåŠ¨çŠ¶æ€å˜åŒ–å®šæ—¶å™¨
  useEffect(() => {
    if (isAutoChanging) {
      autoChangeInterval.current = setInterval(autoChangeState, 8000) // æ¯8ç§’å˜åŒ–ä¸€æ¬¡
    } else {
      if (autoChangeInterval.current) {
        clearInterval(autoChangeInterval.current)
        autoChangeInterval.current = null
      }
    }
    
    return () => {
      if (autoChangeInterval.current) {
        clearInterval(autoChangeInterval.current)
      }
    }
  }, [isAutoChanging, pandaState])

  // éšæœºç§»åŠ¨å®šæ—¶å™¨
  useEffect(() => {
    randomMoveInterval.current = setInterval(randomMovePanda, 15000) // æ¯15ç§’éšæœºç§»åŠ¨ä¸€æ¬¡
    
    return () => {
      if (randomMoveInterval.current) {
        clearInterval(randomMoveInterval.current)
      }
    }
  }, [isDragging, screenSize])

  // åˆå§‹åŒ–
  useEffect(() => {
    console.log('ğŸš€ å°ç«¹å­æ¡Œé¢å® ç‰©å¯åŠ¨ä¸­...')
    
    const makeVisible = async () => {
      try {
        const window = getCurrentWindow()
        await window.setAlwaysOnTop(true)
        await window.show()
        await window.setFocus()
        console.log('âœ… çª—å£å·²è®¾ç½®ä¸ºå¯è§')
        
        // æ˜¾ç¤ºæ¬¢è¿å­—å¹•
        showSubtitle({
          id: 'welcome',
          text: 'ä½ å¥½ï¼æˆ‘æ˜¯å°ç«¹å­ï¼Œä½ çš„AIæ¡Œé¢åŠ©æ‰‹ï¼ğŸ¼',
          duration: 4000,
          type: 'normal'
        })
      } catch (error) {
        console.error('âŒ è®¾ç½®çª—å£å¯è§æ€§å¤±è´¥:', error)
      }
    }
    
    makeVisible()
  }, [])

  // è®¡ç®—UIå…ƒç´ ä½ç½® - ä¼˜åŒ–ä¸º500x500çª—å£
  const getSubtitlePosition = () => {
    const left = Math.max(10, Math.min(position.x - 150, screenSize.width - 310))
    const top = Math.max(10, position.y - 80)
    return { left, top }
  }

  const getContextMenuPosition = () => {
    const left = Math.max(10, Math.min(position.x + 160, screenSize.width - 210))
    const top = Math.max(10, Math.min(position.y + 50, screenSize.height - 250))
    return { left, top }
  }

  const getFunctionWindowPosition = () => {
    const left = Math.max(10, Math.min(position.x - 200, screenSize.width - 410))
    const top = Math.max(10, Math.min(position.y - 200, screenSize.height - 450))
    return { left, top }
  }

  return (
    <div className="app-container">
      {/* å°ç†ŠçŒ«ä¸»ä½“ */}
      <div 
        className="panda-container"
        ref={dragRef}
        style={{
          position: 'absolute',
          left: position.x,
          top: position.y,
          cursor: isDragging ? 'grabbing' : 'grab'
        }}
        onMouseDown={handleMouseDown}
        onMouseMove={handleMouseMove}
        onMouseUp={handleMouseUp}
        onMouseLeave={handleMouseUp}
        onContextMenu={handleContextMenu}
        onClick={handleClick}
      >
        <motion.img 
          src={pandaStates[pandaState].image}
          alt="å°ç«¹å­"
          className="panda-image"
          initial={{ opacity: 0, scale: 0.5 }}
          animate={{ 
            opacity: 1, 
            scale: isAnimating ? 1.2 : 1,
            rotate: isAnimating ? [0, 10, -10, 0] : 0
          }}
          transition={{ 
            duration: isAnimating ? 0.6 : 1,
            rotate: { duration: 0.6 }
          }}
        />
        
        {/* çŠ¶æ€æŒ‡ç¤ºå™¨ */}
        <div className="state-indicator">
          {pandaStates[pandaState].name}
        </div>
        
        {/* å¿ƒæƒ…æŒ‡ç¤ºå™¨ */}
        <div className={`mood-indicator mood-${mood}`}>
          {mood === 'happy' && 'ğŸ˜Š'}
          {mood === 'normal' && 'ğŸ˜Œ'}
          {mood === 'tired' && 'ğŸ˜´'}
          {mood === 'excited' && 'ğŸ‰'}
        </div>

        {/* æ‹–æ‹½æç¤º */}
        <div className="drag-hint">
          æ‹–æ‹½ç§»åŠ¨
        </div>
      </div>

      {/* å­—å¹•æ˜¾ç¤º */}
      <AnimatePresence>
        {currentSubtitle && (
          <motion.div 
            className="subtitle"
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -20 }}
            style={{
              position: 'absolute',
              left: getSubtitlePosition().left,
              top: getSubtitlePosition().top,
              zIndex: 1000
            }}
          >
            <div className={`subtitle-content ${currentSubtitle.type}`}>
              {currentSubtitle.text}
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* å³é”®èœå• */}
      <AnimatePresence>
        {showContextMenu && (
          <motion.div 
            className="context-menu"
            initial={{ opacity: 0, scale: 0.8 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.8 }}
            style={{
              position: 'absolute',
              left: getContextMenuPosition().left,
              top: getContextMenuPosition().top,
              zIndex: 1001
            }}
          >
            <div className="menu-section">åŸºæœ¬è®¾ç½®</div>
            <div className="menu-item" onClick={toggleAutoChange}>
              {isAutoChanging ? 'â¸ï¸ åœæ­¢è‡ªåŠ¨å˜åŒ–' : 'â–¶ï¸ å¼€å§‹è‡ªåŠ¨å˜åŒ–'}
            </div>
            <div className="menu-item" onClick={() => setPandaState('normal')}>
              ğŸ¼ é‡ç½®çŠ¶æ€
            </div>
            
            <div className="menu-separator" />
            <div className="menu-section">å¿ƒæƒ…è®¾ç½®</div>
            <div className="menu-item" onClick={() => changeMood('happy')}>
              ğŸ˜Š å¼€å¿ƒ
            </div>
            <div className="menu-item" onClick={() => changeMood('normal')}>
              ğŸ˜Œ å¹³é™
            </div>
            <div className="menu-item" onClick={() => changeMood('tired')}>
              ğŸ˜´ ç–²æƒ«
            </div>
            <div className="menu-item" onClick={() => changeMood('excited')}>
              ğŸ‰ å…´å¥‹
            </div>
            
            <div className="menu-separator" />
            <div className="menu-section">ä¼ä¸šåŠŸèƒ½</div>
            {Object.entries(enterpriseFunctions).map(([key, func]) => (
              <div 
                key={key}
                className="menu-item"
                onClick={() => openEnterpriseFunction(key as EnterpriseFunction)}
              >
                {func.icon} {func.name}
              </div>
            ))}
          </motion.div>
        )}
      </AnimatePresence>

      {/* ä¼ä¸šåŠŸèƒ½çª—å£ */}
      <AnimatePresence>
        {showFunctionWindow && (
          <motion.div 
            className="function-window"
            initial={{ opacity: 0, scale: 0.8 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.8 }}
            style={{
              position: 'absolute',
              left: getFunctionWindowPosition().left,
              top: getFunctionWindowPosition().top,
              zIndex: 1002
            }}
          >
            <div className="function-header">
              <h3>{enterpriseFunctions[showFunctionWindow].icon} {enterpriseFunctions[showFunctionWindow].name}</h3>
              <button 
                className="close-btn"
                onClick={() => setShowFunctionWindow(null)}
              >
                Ã—
              </button>
            </div>
            <div className="function-content">
              <p>{enterpriseFunctions[showFunctionWindow].description}</p>
              
              {showFunctionWindow === 'chat' ? (
                <div className="chat-interface">
                  <div className="chat-messages">
                    {chatMessages.map((message) => (
                      <div key={message.id} className={`message ${message.type}`}>
                        <div className="message-content">{message.text}</div>
                        <div className="message-time">
                          {message.timestamp.toLocaleTimeString()}
                        </div>
                      </div>
                    ))}
                  </div>
                  <div className="chat-input-container">
                    <input
                      type="text"
                      className="chat-input"
                      value={chatInput}
                      onChange={(e) => setChatInput(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && sendChatMessage()}
                      placeholder="è¾“å…¥æ¶ˆæ¯..."
                    />
                    <button 
                      className="send-btn"
                      onClick={sendChatMessage}
                      disabled={!chatInput.trim()}
                    >
                      å‘é€
                    </button>
                  </div>
                </div>
              ) : (
                <div className="function-placeholder">
                  <p>ğŸš§ åŠŸèƒ½å¼€å‘ä¸­...</p>
                  <p>è¿™é‡Œå°†é›†æˆè…¾è®¯äº‘ADPæ™ºèƒ½ä½“</p>
                  <p>æ”¯æŒLLM+RAGã€Workflowã€MCPæ’ä»¶</p>
                  <div className="integration-status">
                    <div className="status-item">
                      <span className="status-icon">ğŸ¤–</span>
                      <span>LLMå¯¹è¯å¼•æ“</span>
                      <span className="status-badge">å·²é›†æˆ</span>
                    </div>
                    <div className="status-item">
                      <span className="status-icon">ğŸ“š</span>
                      <span>RAGçŸ¥è¯†åº“</span>
                      <span className="status-badge">å¼€å‘ä¸­</span>
                    </div>
                    <div className="status-item">
                      <span className="status-icon">âš¡</span>
                      <span>Workflowå¼•æ“</span>
                      <span className="status-badge">å¼€å‘ä¸­</span>
                    </div>
                    <div className="status-item">
                      <span className="status-icon">ğŸ”Œ</span>
                      <span>MCPæ’ä»¶ç”Ÿæ€</span>
                      <span className="status-badge">å¼€å‘ä¸­</span>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  )
}

export default App
