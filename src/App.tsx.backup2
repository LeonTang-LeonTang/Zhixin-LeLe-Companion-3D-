import React, { useEffect, useState, useRef } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { invoke } from '@tauri-apps/api/core'
import { getCurrentWindow } from '@tauri-apps/api/window'
import { useAppStore } from './stores/appStore'
import { adpService } from './services/adpService'
import { PandaMood } from './types'
import './App.css'

// å¯¼å…¥å›¾ç‰‡èµ„æº
import pandaNormal from './assets/images/panda-normal.png'
import pandaWalking from './assets/images/panda-walking.png'
import pandaYawning from './assets/images/panda-yawning.png'

function App() {
  const [isDragging, setIsDragging] = useState(false)
  const [showMenu, setShowMenu] = useState(false)
  const [eyePosition, setEyePosition] = useState({ x: 0, y: 0 })
  const [currentBehavior, setCurrentBehavior] = useState<string>('normal')
  const [isWalking, setIsWalking] = useState(false)
  const [behaviorIndex, setBehaviorIndex] = useState(0)
  const [imageLoaded, setImageLoaded] = useState(false)
  const dragRef = useRef<{ startX: number; startY: number; windowX: number; windowY: number }>({ 
    startX: 0, 
    startY: 0, 
    windowX: 0, 
    windowY: 0 
  })
  const behaviorIntervalRef = useRef<NodeJS.Timeout>()

  const { 
    panda, 
    setPandaMood, 
    setAnimating, 
    updatePandaAction 
  } = useAppStore()

  // é¢„åŠ è½½å›¾ç‰‡å¹¶ç¡®ä¿åŠ è½½å®Œæˆ
  useEffect(() => {
    const preloadImages = [pandaNormal, pandaWalking, pandaYawning]
    let loadedCount = 0
    
    preloadImages.forEach(src => {
      const img = new Image()
      img.onload = () => {
        loadedCount++
        if (loadedCount === preloadImages.length) {
          setImageLoaded(true)
          console.log('æ‰€æœ‰ç†ŠçŒ«å›¾ç‰‡åŠ è½½å®Œæˆï¼')
        }
      }
      img.onerror = () => {
        console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', src)
      }
      img.src = src
    })
  }, [])

  // åˆå§‹åŒ–
  useEffect(() => {
    if (imageLoaded) {
      adpService.initialize()
      
      setTimeout(() => {
        updatePandaAction('ä½ å¥½ï¼æˆ‘æ˜¯å°ç«¹å­ ğŸ‹ ç‚¹å‡»æˆ‘å¯ä»¥åˆ‡æ¢çŠ¶æ€ï¼Œå³é”®æŸ¥çœ‹èœå•ï¼')
        setAnimating(true)
        setTimeout(() => setAnimating(false), 4000)
      }, 1000)

      // çœ¼ç›è·Ÿè¸ªé¼ æ ‡
      const handleMouseMove = (e: MouseEvent) => {
        const rect = document.querySelector('.panda-character')?.getBoundingClientRect()
        if (rect) {
          const centerX = rect.left + rect.width / 2
          const centerY = rect.top + rect.height / 2
          const deltaX = (e.clientX - centerX) / 100
          const deltaY = (e.clientY - centerY) / 100
          
          setEyePosition({
            x: Math.max(-2, Math.min(2, deltaX)),
            y: Math.max(-1, Math.min(1, deltaY))
          })
        }
      }

      document.addEventListener('mousemove', handleMouseMove)
      
      // å¯åŠ¨éšæœºè¡Œä¸º - 5ç§’é—´éš”
      startRandomBehaviors()
      
      return () => {
        document.removeEventListener('mousemove', handleMouseMove)
        if (behaviorIntervalRef.current) {
          clearInterval(behaviorIntervalRef.current)
        }
      }
    }
  }, [imageLoaded])

  // éšæœºè¡Œä¸ºç³»ç»Ÿ - 5ç§’é—´éš”
  const startRandomBehaviors = () => {
    behaviorIntervalRef.current = setInterval(() => {
      if (!isDragging && !showMenu && panda.mood !== PandaMood.SLEEPING) {
        performRandomBehavior()
      }
    }, 5000) // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡éšæœºè¡Œä¸º
  }

  // ç‚¹å‡»åˆ‡æ¢çŠ¶æ€åŠŸèƒ½ - ä¸‰ä¸ªçŠ¶æ€å¾ªç¯
  const cycleThroughBehaviors = () => {
    const behaviors = ['normal', 'walking', 'yawning']
    const nextIndex = (behaviorIndex + 1) % behaviors.length
    setBehaviorIndex(nextIndex)
    
    const behavior = behaviors[nextIndex]
    setCurrentBehavior(behavior)
    
    switch (behavior) {
      case 'walking':
        performWalk()
        break
      case 'yawning':
        performYawn()
        break
      default:
        setPandaMood(PandaMood.HAPPY)
        updatePandaAction('çŠ¶æ€åˆ‡æ¢å®Œæˆï¼')
        setAnimating(true)
        setTimeout(() => setAnimating(false), 2000)
    }
  }

  // éšæœºè¡Œä¸º
  const performRandomBehavior = () => {
    const behaviors = ['normal', 'yawning', 'eating', 'stretching', 'looking']
    const randomBehavior = behaviors[Math.floor(Math.random() * behaviors.length)]
    
    switch (randomBehavior) {
      case 'yawning':
        performYawn()
        break
      case 'eating':
        performEatBamboo()
        break
      case 'stretching':
        performStretch()
        break
      case 'looking':
        performLookAround()
        break
      default:
        setPandaMood(PandaMood.HAPPY)
        updatePandaAction('éšæœºè¡Œä¸ºï¼šä¿æŒå¯çˆ±~')
        setAnimating(true)
        setTimeout(() => setAnimating(false), 2000)
    }
  }

  const performEatBamboo = () => {
    setCurrentBehavior('eating')
    setPandaMood(PandaMood.HAPPY)
    updatePandaAction('åƒç«¹å­æ—¶é—´ï¼ğŸ‹')
    setAnimating(true)
    
    setTimeout(() => {
      setCurrentBehavior('normal')
      setPandaMood(PandaMood.SATISFIED)
      updatePandaAction('ç«¹å­çœŸå¥½åƒ~')
      setAnimating(false)
    }, 3000)
  }

  const performYawn = () => {
    setCurrentBehavior('yawning')
    setPandaMood(PandaMood.SLEEPY)
    updatePandaAction('æœ‰ç‚¹å›°äº†...ğŸ˜´')
    setAnimating(true)
    
    setTimeout(() => {
      setCurrentBehavior('normal')
      setPandaMood(PandaMood.HAPPY)
      updatePandaAction('æ‰“å“ˆæ¬ çœŸèˆ’æœ~')
      setAnimating(false)
    }, 2500)
  }

  const performStretch = () => {
    setCurrentBehavior('stretching')
    setPandaMood(PandaMood.ENERGETIC)
    updatePandaAction('ä¼¸ä¸ªæ‡’è…°ï¼ğŸ¤¸')
    setAnimating(true)
    
    setTimeout(() => {
      setCurrentBehavior('normal')
      setPandaMood(PandaMood.HAPPY)
      updatePandaAction('ä¼¸å±•å®Œæ¯•ï¼')
      setAnimating(false)
    }, 2000)
  }

  const performLookAround = () => {
    setCurrentBehavior('looking')
    setPandaMood(PandaMood.CURIOUS)
    updatePandaAction('çœ‹çœ‹å‘¨å›´æœ‰ä»€ä¹ˆ...')
    setAnimating(true)
    
    setTimeout(() => {
      setCurrentBehavior('normal')
      setPandaMood(PandaMood.HAPPY)
      updatePandaAction('æ²¡å‘ç°ä»€ä¹ˆç‰¹åˆ«çš„~')
      setAnimating(false)
    }, 3000)
  }

  const performWalk = async () => {
    setCurrentBehavior('walking')
    setIsWalking(true)
    setPandaMood(PandaMood.EXCITED)
    updatePandaAction('å¼€å§‹æ•£æ­¥ï¼ğŸš¶')
    setAnimating(true)

    try {
      const window = getCurrentWindow()
      const screenWidth = 1920
      const screenHeight = 1080
      
      // éšæœºç›®æ ‡ä½ç½®
      const targetX = Math.random() * (screenWidth - 600) // ä½¿ç”¨æ–°çš„çª—å£å®½åº¦
      const targetY = Math.random() * (screenHeight - 600) // ä½¿ç”¨æ–°çš„çª—å£é«˜åº¦
      
      // ç§»åŠ¨çª—å£
      await window.setPosition({ x: Math.floor(targetX), y: Math.floor(targetY) })
      
      setTimeout(() => {
        setCurrentBehavior('normal')
        setIsWalking(false)
        setPandaMood(PandaMood.HAPPY)
        updatePandaAction('æ•£æ­¥ç»“æŸï¼')
        setAnimating(false)
      }, 2000)
    } catch (error) {
      console.error('æ•£æ­¥å¤±è´¥:', error)
      setCurrentBehavior('normal')
      setIsWalking(false)
      setAnimating(false)
    }
  }

  const performPlay = () => {
    setCurrentBehavior('playing')
    setPandaMood(PandaMood.EXCITED)
    updatePandaAction('ç©è€æ—¶é—´ï¼ğŸ®')
    setAnimating(true)
    
    setTimeout(() => {
      setCurrentBehavior('normal')
      setPandaMood(PandaMood.HAPPY)
      updatePandaAction('ç©å¾—çœŸå¼€å¿ƒ~')
      setAnimating(false)
    }, 3500)
  }

  // æ”¹è¿›çš„é¼ æ ‡äº‹ä»¶å¤„ç† - ä¿®å¤æ‹–æ‹½åŠŸèƒ½
  const handleMouseDown = async (e: React.MouseEvent) => {
    if (e.button === 0) { // å·¦é”®
      e.preventDefault() // é˜²æ­¢é»˜è®¤è¡Œä¸º
      setIsDragging(true)
      setPandaMood(PandaMood.EXCITED)
      updatePandaAction('è¢«æŠ“ä½äº†ï¼')
      
      try {
        const window = getCurrentWindow()
        const currentPos = await window.outerPosition()
        
        dragRef.current = { 
          startX: e.clientX, 
          startY: e.clientY,
          windowX: currentPos.x,
          windowY: currentPos.y
        }
        
        console.log('å¼€å§‹æ‹–æ‹½:', dragRef.current)
      } catch (error) {
        console.error('è·å–çª—å£ä½ç½®å¤±è´¥:', error)
        dragRef.current = { 
          startX: e.clientX, 
          startY: e.clientY,
          windowX: 0,
          windowY: 0
        }
      }
    }
  }

  const handleMouseMove = async (e: React.MouseEvent) => {
    if (!isDragging) return

    e.preventDefault() // é˜²æ­¢é»˜è®¤è¡Œä¸º
    
    try {
      const deltaX = e.clientX - dragRef.current.startX
      const deltaY = e.clientY - dragRef.current.startY
      
      const window = getCurrentWindow()
      const newX = dragRef.current.windowX + deltaX
      const newY = dragRef.current.windowY + deltaY
      
      // ç¡®ä¿çª—å£ä¸ä¼šç§»å‡ºå±å¹•
      const screenWidth = window.screen?.availWidth || 1920
      const screenHeight = window.screen?.availHeight || 1080
      const windowWidth = 600 // ä½¿ç”¨æ–°çš„çª—å£å®½åº¦
      const windowHeight = 600 // ä½¿ç”¨æ–°çš„çª—å£é«˜åº¦
      
      const clampedX = Math.max(0, Math.min(newX, screenWidth - windowWidth))
      const clampedY = Math.max(0, Math.min(newY, screenHeight - windowHeight))
      
      await window.setPosition({ x: Math.floor(clampedX), y: Math.floor(clampedY) })
      
      console.log('æ‹–æ‹½ä¸­:', { deltaX, deltaY, newX: clampedX, newY: clampedY })
    } catch (error) {
      console.error('æ‹–æ‹½å¤±è´¥:', error)
    }
  }

  const handleMouseUp = (e: React.MouseEvent) => {
    if (isDragging) {
      e.preventDefault() // é˜²æ­¢é»˜è®¤è¡Œä¸º
      setIsDragging(false)
      setPandaMood(PandaMood.HAPPY)
      updatePandaAction('æ”¾å¼€æˆ‘äº†~')
      console.log('æ‹–æ‹½ç»“æŸ')
    }
  }

  // ç‚¹å‡»äº‹ä»¶å¤„ç†
  const handleClick = (e: React.MouseEvent) => {
    if (e.button === 0 && !isDragging) { // å·¦é”®ä¸”éæ‹–æ‹½
      e.preventDefault()
      cycleThroughBehaviors()
    }
  }

  // å³é”®èœå•
  const handleRightClick = (e: React.MouseEvent) => {
    e.preventDefault()
    setShowMenu(!showMenu)
    setPandaMood(PandaMood.THINKING)
    updatePandaAction('çœ‹çœ‹æœ‰ä»€ä¹ˆåŠŸèƒ½...')
  }

  // åŒå‡»äº‹ä»¶
  const handleDoubleClick = async () => {
    setPandaMood(PandaMood.EXCITED)
    updatePandaAction('æ‰“å¼€èŠå¤©çª—å£ï¼')
    setAnimating(true)
    
    try {
      await invoke('create_chat_window')
    } catch (error) {
      console.error('åˆ›å»ºèŠå¤©çª—å£å¤±è´¥:', error)
    }
    
    setTimeout(() => setAnimating(false), 2000)
  }

  // æ ¹æ®è¡Œä¸ºè·å–å¯¹åº”çš„å›¾ç‰‡ - ä½¿ç”¨å¯¼å…¥çš„å›¾ç‰‡
  const getPandaImage = () => {
    switch (currentBehavior) {
      case 'walking':
        return pandaWalking
      case 'yawning':
        return pandaYawning
      case 'normal':
      case 'idle':
      case 'eating':
      case 'stretching':
      case 'looking':
      case 'playing':
      default:
        return pandaNormal
    }
  }

  // å¦‚æœå›¾ç‰‡è¿˜æ²¡åŠ è½½å®Œæˆï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
  if (!imageLoaded) {
    return (
      <div className="desktop-pet">
        <div className="loading-container">
          <div className="loading-panda">ğŸ¼</div>
          <div className="loading-text">å°ç«¹å­æ­£åœ¨åŠ è½½ä¸­...</div>
        </div>
      </div>
    )
  }

  return (
    <div className="desktop-pet">
      {/* è¶…å¯çˆ±çš„ç†ŠçŒ« */}
      <motion.div
        className={`panda-character ${isDragging ? 'dragging' : ''}`}
        onMouseDown={handleMouseDown}
        onMouseMove={handleMouseMove}
        onMouseUp={handleMouseUp}
        onClick={handleClick}
        onContextMenu={handleRightClick}
        onDoubleClick={handleDoubleClick}
        animate={panda.isAnimating ? {
          scale: [1, 1.1, 1],
          y: [0, -8, 0],
          transition: { duration: 0.6, repeat: 3 }
        } : {}}
        whileHover={{ scale: 1.05, y: -3 }}
      >
        {/* ç†ŠçŒ«å›¾ç‰‡ä¸»ä½“ */}
        <div className="panda-image-container">
          <motion.img 
            key={currentBehavior} // å…³é”®ï¼šå½“è¡Œä¸ºæ”¹å˜æ—¶é‡æ–°æ¸²æŸ“
            src={getPandaImage()} 
            alt="å°ç«¹å­"
            className={`panda-image mood-${panda.mood} behavior-${currentBehavior} ${isDragging ? 'dragging' : ''} ${isWalking ? 'walking' : ''}`}
            draggable={false}
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ duration: 0.3, ease: "easeOut" }}
            onLoad={() => console.log('ç†ŠçŒ«å›¾ç‰‡åŠ è½½æˆåŠŸ:', currentBehavior)}
            onError={(e) => console.error('ç†ŠçŒ«å›¾ç‰‡åŠ è½½å¤±è´¥:', e)}
          />
          
          {/* è¡Œä¸ºç‰¹æ•ˆè¦†ç›–å±‚ */}
          {currentBehavior === 'eating' && (
            <div className="behavior-effects eating-effects">
              <div className="bamboo-leaf">ğŸ‹</div>
              <div className="chew-particles">
                <span>âœ¨</span>
                <span>âœ¨</span>
                <span>âœ¨</span>
              </div>
            </div>
          )}
          
          {currentBehavior === 'yawning' && (
            <div className="behavior-effects yawn-effects">
              <div className="yawn-bubble">ğŸ’¤</div>
            </div>
          )}
          
          {currentBehavior === 'playing' && (
            <div className="behavior-effects play-effects">
              <div className="play-sparkles">
                <span>ğŸŒŸ</span>
                <span>â­</span>
                <span>âœ¨</span>
                <span>ğŸ’«</span>
              </div>
            </div>
          )}
          
          {isWalking && (
            <div className="behavior-effects walk-effects">
              <div className="footprints">
                <span className="footprint">ğŸ¾</span>
                <span className="footprint">ğŸ¾</span>
              </div>
            </div>
          )}
          
          {/* å¿ƒæƒ…æŒ‡ç¤ºå™¨ */}
          <div className={`mood-indicator ${panda.mood}`}>
            <div className="mood-pulse"></div>
          </div>
          
          {/* çœ¼ç›è·Ÿè¸ªæ•ˆæœè¦†ç›–å±‚ */}
          <div className="eye-tracking-overlay">
            <div 
              className="eye-glow left-eye-glow"
              style={{
                transform: `translate(${eyePosition.x * 3}px, ${eyePosition.y * 2}px)`
              }}
            ></div>
            <div 
              className="eye-glow right-eye-glow"
              style={{
                transform: `translate(${eyePosition.x * 3}px, ${eyePosition.y * 2}px)`
              }}
            ></div>
          </div>
        </div>

        {/* åŠ¨ä½œæ°”æ³¡ - ä¼˜åŒ–æ˜¾ç¤º */}
        <AnimatePresence>
          {panda.currentAction && panda.currentAction !== 'ç­‰å¾…ä¸­...' && (
            <motion.div
              className="action-bubble"
              initial={{ opacity: 0, y: 15, scale: 0.7 }}
              animate={{ opacity: 1, y: 0, scale: 1 }}
              exit={{ opacity: 0, y: -15, scale: 0.7 }}
              transition={{ duration: 0.4, ease: "easeOut" }}
            >
              {panda.currentAction}
              <div className="bubble-tail"></div>
            </motion.div>
          )}
        </AnimatePresence>
      </motion.div>

      {/* å³é”®èœå• - ä¼˜åŒ–æ˜¾ç¤º */}
      <AnimatePresence>
        {showMenu && (
          <motion.div
            className="context-menu"
            initial={{ opacity: 0, scale: 0.8, y: 10 }}
            animate={{ opacity: 1, scale: 1, y: 0 }}
            exit={{ opacity: 0, scale: 0.8, y: 10 }}
            transition={{ duration: 0.2, ease: "easeOut" }}
          >
            <div className="menu-item" onClick={() => {
              handleDoubleClick()
              setShowMenu(false)
            }}>
              ğŸ’¬ èŠå¤©å¯¹è¯
            </div>
            <div className="menu-divider"></div>
            <div className="menu-item" onClick={() => {
              cycleThroughBehaviors()
              setShowMenu(false)
            }}>
              ï¿½ï¿½ åˆ‡æ¢çŠ¶æ€
            </div>
            <div className="menu-item" onClick={() => {
              performEatBamboo()
              setShowMenu(false)
            }}>
              ğŸ‹ åƒç«¹å­
            </div>
            <div className="menu-item" onClick={() => {
              performYawn()
              setShowMenu(false)
            }}>
              ğŸ˜´ æ‰“å“ˆæ¬ 
            </div>
            <div className="menu-item" onClick={() => {
              performStretch()
              setShowMenu(false)
            }}>
              ğŸ¤¸ ä¼¸æ‡’è…°
            </div>
            <div className="menu-item" onClick={() => {
              performPlay()
              setShowMenu(false)
            }}>
              ğŸ® ç©è€
            </div>
            <div className="menu-item" onClick={() => {
              performWalk()
              setShowMenu(false)
            }}>
              ğŸš¶ æ•£æ­¥
            </div>
            <div className="menu-divider"></div>
            <div className="menu-item" onClick={() => {
              setPandaMood(PandaMood.ENERGETIC)
              updatePandaAction('å……æ»¡æ´»åŠ›ï¼')
              setAnimating(true)
              setShowMenu(false)
              setTimeout(() => setAnimating(false), 3000)
            }}>
              âš¡ æ´»åŠ›æ¨¡å¼
            </div>
            <div className="menu-divider"></div>
            <div className="menu-item danger" onClick={async () => {
              const window = getCurrentWindow()
              await window.close()
            }}>
              âŒ é€€å‡ºç¨‹åº
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  )
}

export default App
