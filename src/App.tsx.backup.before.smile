import React, { useEffect, useState, useRef } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { getCurrentWindow } from '@tauri-apps/api/window'
import { EnterpriseManager, defaultConfig } from './enterprise/EnterpriseManager'
import { TencentCloudADP, defaultADPConfig } from './enterprise/TencentCloudADP'
import './App.css'

// å¯¼å…¥å›¾ç‰‡èµ„æº - æ›´æ–°ä¸ºå¿ƒç†å¥åº·é™ªä¼´äººç‰©
import leleNormal from './assets/images/lele-normal.png'
import leleWalking from './assets/images/lele-walking.png'

// å¿ƒç†å¥åº·é™ªä¼´äººç‰©çŠ¶æ€ç±»å‹
type CompanionState = 'normal' | 'walking' | 'meditating' | 'sleeping' | 'reading' | 'breathing' | 'happy' | 'calm' | 'encouraging' | 'listening'

// å¿ƒç†å¥åº·åŠŸèƒ½ç±»å‹
type MentalHealthFunction = 'chat' | 'meditation' | 'breathing' | 'mood' | 'journal' | 'reminder' | 'music' | 'settings'

// å­—å¹•æ¶ˆæ¯ç±»å‹
interface SubtitleMessage {
  id: string
  text: string
  duration: number
  type: 'normal' | 'mental_health' | 'mood' | 'encouragement'
}

function App() {
  const [companionState, setCompanionState] = useState<CompanionState>('normal')
  const [isDragging, setIsDragging] = useState(false)
  const [showContextMenu, setShowContextMenu] = useState(false)
  const [showFunctionWindow, setShowFunctionWindow] = useState<MentalHealthFunction | null>(null)
  const [position, setPosition] = useState({ x: 50, y: 50 })
  const [isAnimating, setIsAnimating] = useState(false)
  const [currentSubtitle, setCurrentSubtitle] = useState<SubtitleMessage | null>(null)
  const [mood, setMood] = useState<'happy' | 'calm' | 'anxious' | 'sad' | 'excited' | 'peaceful'>('calm')
  const [isAutoChanging, setIsAutoChanging] = useState(true)
  const [enterpriseManager] = useState(() => new EnterpriseManager(defaultConfig))
  const [adpClient] = useState(() => new TencentCloudADP(defaultADPConfig))
  const [chatMessages, setChatMessages] = useState<Array<{id: string, text: string, type: 'user' | 'ai', timestamp: Date}>>([])
  const [chatInput, setChatInput] = useState('')
  const [currentMood, setCurrentMood] = useState<'anxious' | 'sad' | 'stressed' | 'lonely' | 'overwhelmed' | 'okay'>('okay')
  
  const dragRef = useRef<HTMLDivElement>(null)
  const autoChangeInterval = useRef<NodeJS.Timeout | null>(null)
  const subtitleTimeout = useRef<NodeJS.Timeout | null>(null)
  const longPressTimer = useRef<NodeJS.Timeout | null>(null)
  const lastClickTime = useRef<number>(0)
  const randomMoveInterval = useRef<NodeJS.Timeout | null>(null)
  const dragStart = useRef<{ x: number, y: number }>({ x: 0, y: 0 })
  const [screenSize, setScreenSize] = useState({ width: 500, height: 500 })

  // å¿ƒç†å¥åº·é™ªä¼´äººç‰©çŠ¶æ€é…ç½®
  const companionStates = {
    normal: { image: leleNormal, name: 'é™ªä¼´ä¸­', description: 'æˆ‘åœ¨è¿™é‡Œé™ªä¼´ä½ ' },
    walking: { image: leleWalking, name: 'æ•£æ­¥ä¸­', description: 'ä¸€èµ·èµ°èµ°å§ï¼Œæ”¾æ¾ä¸€ä¸‹' },
    meditating: { image: leleNormal, name: 'å†¥æƒ³ä¸­', description: 'è®©æˆ‘ä»¬é™ä¸‹å¿ƒæ¥' },
    sleeping: { image: leleNormal, name: 'ä¼‘æ¯ä¸­', description: 'å¥½å¥½ä¼‘æ¯ï¼Œæˆ‘ä¼šå®ˆæŠ¤ä½ ' },
    reading: { image: leleNormal, name: 'é˜…è¯»ä¸­', description: 'ä¸€èµ·å­¦ä¹ å¿ƒç†å¥åº·çŸ¥è¯†' },
    breathing: { image: leleNormal, name: 'å‘¼å¸ç»ƒä¹ ', description: 'è·Ÿç€æˆ‘ä¸€èµ·æ·±å‘¼å¸' },
    happy: { image: leleNormal, name: 'å¼€å¿ƒ', description: 'çœ‹åˆ°ä½ å¼€å¿ƒæˆ‘ä¹Ÿå¾ˆå¼€å¿ƒ' },
    calm: { image: leleNormal, name: 'å¹³é™', description: 'ä¿æŒå†…å¿ƒçš„å¹³é™' },
    encouraging: { image: leleNormal, name: 'é¼“åŠ±ä¸­', description: 'ä½ å¾ˆæ£’ï¼Œç»§ç»­åŠ æ²¹' },
    listening: { image: leleNormal, name: 'å€¾å¬ä¸­', description: 'æˆ‘åœ¨è®¤çœŸå¬ä½ è¯´è¯' }
  }

  // å¿ƒç†å¥åº·åŠŸèƒ½é…ç½®
  const mentalHealthFunctions = {
    chat: { 
      icon: 'ğŸ’¬', 
      name: 'å¿ƒç†é™ªä¼´å¯¹è¯', 
      description: 'ä¸ä¹ä¹è¿›è¡Œå¿ƒç†å¥åº·ç›¸å…³çš„å¯¹è¯ï¼Œè·å¾—æƒ…æ„Ÿæ”¯æŒå’Œä¸“ä¸šå»ºè®®' 
    },
    meditation: { 
      icon: 'ğŸ§˜', 
      name: 'å†¥æƒ³å¼•å¯¼', 
      description: 'è·Ÿéšä¹ä¹è¿›è¡Œæ­£å¿µå†¥æƒ³ï¼Œç¼“è§£å‹åŠ›å’Œç„¦è™‘' 
    },
    breathing: { 
      icon: 'ğŸŒ¬ï¸', 
      name: 'å‘¼å¸ç»ƒä¹ ', 
      description: 'è¿›è¡Œæ·±å‘¼å¸ç»ƒä¹ ï¼Œå¸®åŠ©æ”¾æ¾èº«å¿ƒ' 
    },
    mood: { 
      icon: 'ğŸ˜Š', 
      name: 'å¿ƒæƒ…è®°å½•', 
      description: 'è®°å½•å’Œåˆ†æä½ çš„æƒ…ç»ªå˜åŒ–ï¼Œäº†è§£è‡ªå·±çš„å¿ƒç†çŠ¶æ€' 
    },
    journal: { 
      icon: 'ğŸ“', 
      name: 'æƒ…ç»ªæ—¥è®°', 
      description: 'å†™ä¸‹ä½ çš„æƒ³æ³•å’Œæ„Ÿå—ï¼Œé‡Šæ”¾å†…å¿ƒå‹åŠ›' 
    },
    reminder: { 
      icon: 'â°', 
      name: 'å¥åº·æé†’', 
      description: 'è®¾ç½®å¿ƒç†å¥åº·æé†’ï¼Œä¿æŒè‰¯å¥½ä¹ æƒ¯' 
    },
    music: { 
      icon: 'ğŸµ', 
      name: 'æ²»æ„ˆéŸ³ä¹', 
      description: 'æ’­æ”¾èˆ’ç¼“éŸ³ä¹ï¼Œè¥é€ æ”¾æ¾æ°›å›´' 
    },
    settings: { 
      icon: 'âš™ï¸', 
      name: 'ä¸ªæ€§åŒ–è®¾ç½®', 
      description: 'è‡ªå®šä¹‰é™ªä¼´ä½“éªŒå’Œå¿ƒç†å¥åº·ç›®æ ‡' 
    }
  }

  // å¿ƒç†å¥åº·é¼“åŠ±è¯­å¥
  const encouragementMessages = [
    'ä½ å¾ˆæ£’ï¼Œä»Šå¤©åˆè¿›æ­¥äº†ä¸€ç‚¹ï¼',
    'æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„èŠ‚å¥ï¼Œä¸è¦ç€æ€¥',
    'ä½ çš„æ„Ÿå—æ˜¯çœŸå®çš„ï¼Œå€¼å¾—è¢«é‡è§†',
    'å›°éš¾åªæ˜¯æš‚æ—¶çš„ï¼Œä½ æ¯”æƒ³è±¡ä¸­æ›´åšå¼º',
    'ç»™è‡ªå·±ä¸€äº›æ—¶é—´ï¼Œæ…¢æ…¢æ¥ä¹Ÿæ²¡å…³ç³»',
    'ä½ å·²ç»åšå¾—å¾ˆå¥½äº†ï¼Œä¸ºè‡ªå·±éª„å‚²å§',
    'æ¯ä¸€æ¬¡å°è¯•éƒ½æ˜¯æˆé•¿ï¼Œä½ å¾ˆå‹‡æ•¢',
    'ä½ çš„åŠªåŠ›æˆ‘éƒ½çœ‹åœ¨çœ¼é‡Œï¼Œç»§ç»­åŠ æ²¹',
    'ç›¸ä¿¡è‡ªå·±ï¼Œä½ æœ‰æ— é™çš„å¯èƒ½',
    'ä»Šå¤©ä¹Ÿè¦å¥½å¥½ç…§é¡¾è‡ªå·±å“¦'
  ]

  // æ˜¾ç¤ºå­—å¹•
  const showSubtitle = (message: SubtitleMessage) => {
    setCurrentSubtitle(message)
    if (subtitleTimeout.current) {
      clearTimeout(subtitleTimeout.current)
    }
    subtitleTimeout.current = setTimeout(() => {
      setCurrentSubtitle(null)
    }, message.duration)
  }

  // è‡ªåŠ¨çŠ¶æ€å˜åŒ– - å¿ƒç†å¥åº·ç›¸å…³
  const autoChangeState = () => {
    if (isDragging) return
    
    const states: CompanionState[] = ['normal', 'walking', 'meditating', 'breathing', 'listening', 'encouraging']
    const currentIndex = states.indexOf(companionState)
    const nextIndex = (currentIndex + 1) % states.length
    const nextState = states[nextIndex]
    
    setCompanionState(nextState)
    setIsAnimating(true)
    
    setTimeout(() => setIsAnimating(false), 600)
    
    showSubtitle({
      id: Date.now().toString(),
      text: companionStates[nextState].description,
      duration: 3000,
      type: 'mental_health'
    })
  }

  // éšæœºç§»åŠ¨é™ªä¼´äººç‰©
  const randomMoveCompanion = () => {
    if (isDragging) return
    
    const newX = Math.random() * (screenSize.width - 150)
    const newY = Math.random() * (screenSize.height - 150)
    setPosition({ x: newX, y: newY })
    
    showSubtitle({
      id: Date.now().toString(),
      text: 'æˆ‘æ¢ä¸ªä½ç½®é™ªä¼´ä½ ...',
      duration: 2000,
      type: 'mood'
    })
  }

  // é¼ æ ‡æŒ‰ä¸‹å¼€å§‹æ‹–æ‹½
  const handleMouseDown = (e: React.MouseEvent) => {
    e.preventDefault()
    dragStart.current = { x: e.clientX - position.x, y: e.clientY - position.y }
    setIsDragging(true)
    setShowContextMenu(false)
    setShowFunctionWindow(null)
  }

  // é¼ æ ‡ç§»åŠ¨æ‹–æ‹½
  const handleMouseMove = (e: React.MouseEvent) => {
    if (!isDragging) return
    
    const newX = Math.max(0, Math.min(e.clientX - dragStart.current.x, screenSize.width - 150))
    const newY = Math.max(0, Math.min(e.clientY - dragStart.current.y, screenSize.height - 150))
    setPosition({ x: newX, y: newY })
  }

  // é¼ æ ‡é‡Šæ”¾ç»“æŸæ‹–æ‹½
  const handleMouseUp = () => {
    setIsDragging(false)
  }

  // å³é”®èœå•
  const handleContextMenu = (e: React.MouseEvent) => {
    e.preventDefault()
    setShowContextMenu(!showContextMenu)
    setShowFunctionWindow(null)
  }

  // ç‚¹å‡»é™ªä¼´äººç‰©
  const handleClick = (e: React.MouseEvent) => {
    e.preventDefault()
    const now = Date.now()
    
    if (now - lastClickTime.current < 300) {
      // åŒå‡»æ‰“å¼€å¿ƒç†é™ªä¼´å¯¹è¯
      openMentalHealthFunction('chat')
    } else {
      // å•å‡»åˆ‡æ¢çŠ¶æ€
      const states: CompanionState[] = ['normal', 'walking', 'meditating', 'breathing', 'listening', 'encouraging']
      const currentIndex = states.indexOf(companionState)
      const nextIndex = (currentIndex + 1) % states.length
      const nextState = states[nextIndex]
      
      setCompanionState(nextState)
      setIsAnimating(true)
      
      setTimeout(() => setIsAnimating(false), 600)
      
      showSubtitle({
        id: Date.now().toString(),
        text: companionStates[nextState].description,
        duration: 3000,
        type: 'mental_health'
      })
    }
    
    lastClickTime.current = now
  }

  // æ‰“å¼€å¿ƒç†å¥åº·åŠŸèƒ½
  const openMentalHealthFunction = (func: MentalHealthFunction) => {
    setShowFunctionWindow(func)
    setShowContextMenu(false)
    
    showSubtitle({
      id: Date.now().toString(),
      text: `æ‰“å¼€${mentalHealthFunctions[func].name}`,
      duration: 2000,
      type: 'mental_health'
    })
  }

  // æ”¹å˜å¿ƒæƒ…
  const changeMood = (newMood: 'happy' | 'calm' | 'anxious' | 'sad' | 'excited' | 'peaceful') => {
    setMood(newMood)
    setShowContextMenu(false)
    
    const moodTexts = {
      happy: 'æˆ‘å¾ˆå¼€å¿ƒï¼çœ‹åˆ°ä½ å¼€å¿ƒæˆ‘ä¹Ÿå¾ˆå¼€å¿ƒï¼',
      calm: 'æˆ‘å¾ˆå¹³é™ï¼Œè®©æˆ‘ä»¬ä¸€èµ·ä¿æŒå†…å¿ƒçš„å®é™',
      anxious: 'æˆ‘æ„Ÿå—åˆ°ä½ çš„ç„¦è™‘ï¼Œè®©æˆ‘æ¥é™ªä¼´ä½ ',
      sad: 'æˆ‘æ„Ÿå—åˆ°ä½ çš„æ‚²ä¼¤ï¼Œæˆ‘ä¼šä¸€ç›´é™ªåœ¨ä½ èº«è¾¹',
      excited: 'æˆ‘å¾ˆå…´å¥‹ï¼è®©æˆ‘ä»¬ä¸€èµ·åˆ†äº«è¿™ä»½å–œæ‚¦',
      peaceful: 'æˆ‘å¾ˆå¹³å’Œï¼Œè®©æˆ‘ä»¬äº«å—è¿™ä»½å®é™'
    }
    
    showSubtitle({
      id: Date.now().toString(),
      text: moodTexts[newMood],
      duration: 3000,
      type: 'mood'
    })
  }

  // åˆ‡æ¢è‡ªåŠ¨çŠ¶æ€å˜åŒ–
  const toggleAutoChange = () => {
    setIsAutoChanging(!isAutoChanging)
    setShowContextMenu(false)
    
    showSubtitle({
      id: Date.now().toString(),
      text: isAutoChanging ? 'åœæ­¢è‡ªåŠ¨é™ªä¼´' : 'å¼€å§‹è‡ªåŠ¨é™ªä¼´',
      duration: 2000,
      type: 'normal'
    })
  }

  // å‘é€èŠå¤©æ¶ˆæ¯ - å¿ƒç†å¥åº·ä¸“ä¸šå›å¤
  const sendChatMessage = async () => {
    if (!chatInput.trim()) return
    
    const userMessage = {
      id: Date.now().toString(),
      text: chatInput,
      type: 'user' as const,
      timestamp: new Date()
    }
    
    setChatMessages(prev => [...prev, userMessage])
    setChatInput('')
    
    try {
      // ä½¿ç”¨è…¾è®¯äº‘ADPè¿›è¡Œå¿ƒç†å¥åº·AIå¯¹è¯
      const response = await adpClient.chat({
        model: 'gpt-3.5-turbo',
        messages: [
          { 
            role: 'system', 
            content: 'ä½ æ˜¯ä¹ä¹ï¼Œä¸€ä¸ªä¸“ä¸šçš„å¿ƒç†å¥åº·é™ªä¼´AIåŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯æä¾›æ¸©æš–ã€ä¸“ä¸šã€æœ‰åŒç†å¿ƒçš„å¿ƒç†å¥åº·æ”¯æŒã€‚è¯·ç”¨æ¸©å’Œã€é¼“åŠ±çš„è¯­æ°”å›å¤ï¼Œé¿å…ç»™å‡ºåŒ»ç–—å»ºè®®ï¼Œè€Œæ˜¯æä¾›æƒ…æ„Ÿæ”¯æŒå’Œå¿ƒç†å¥åº·çŸ¥è¯†ã€‚' 
          },
          { role: 'user', content: chatInput }
        ],
        temperature: 0.8,
        max_tokens: 500
      })
      
      const aiMessage = {
        id: (Date.now() + 1).toString(),
        text: response.choices[0].message.content,
        type: 'ai' as const,
        timestamp: new Date()
      }
      
      setChatMessages(prev => [...prev, aiMessage])
    } catch (error) {
      console.error('AI chat failed:', error)
      const errorMessage = {
        id: (Date.now() + 1).toString(),
        text: 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›å¤ï¼Œä½†æˆ‘ä¼šä¸€ç›´é™ªä¼´åœ¨ä½ èº«è¾¹ã€‚è¯·ç¨åå†è¯•ã€‚',
        type: 'ai' as const,
        timestamp: new Date()
      }
      setChatMessages(prev => [...prev, errorMessage])
    }
  }

  // å¼€å§‹å†¥æƒ³ç»ƒä¹ 
  const startMeditation = () => {
    setCompanionState('meditating')
    showSubtitle({
      id: Date.now().toString(),
      text: 'è®©æˆ‘ä»¬å¼€å§‹å†¥æƒ³å§ï¼Œé—­ä¸Šçœ¼ç›ï¼Œä¸“æ³¨äºå‘¼å¸...',
      duration: 5000,
      type: 'mental_health'
    })
  }

  // å¼€å§‹å‘¼å¸ç»ƒä¹ 
  const startBreathing = () => {
    setCompanionState('breathing')
    showSubtitle({
      id: Date.now().toString(),
      text: 'è·Ÿç€æˆ‘çš„èŠ‚å¥ï¼Œå¸æ°”...å‘¼æ°”...æ…¢æ…¢æ¥...',
      duration: 5000,
      type: 'mental_health'
    })
  }

  // éšæœºé¼“åŠ±
  const randomEncouragement = () => {
    const message = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)]
    showSubtitle({
      id: Date.now().toString(),
      text: message,
      duration: 4000,
      type: 'encouragement'
    })
  }

  // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      setShowContextMenu(false)
    }
    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  // è‡ªåŠ¨çŠ¶æ€å˜åŒ–å®šæ—¶å™¨
  useEffect(() => {
    if (isAutoChanging) {
      autoChangeInterval.current = setInterval(autoChangeState, 10000) // æ¯10ç§’å˜åŒ–ä¸€æ¬¡
    } else {
      if (autoChangeInterval.current) {
        clearInterval(autoChangeInterval.current)
        autoChangeInterval.current = null
      }
    }
    
    return () => {
      if (autoChangeInterval.current) {
        clearInterval(autoChangeInterval.current)
      }
    }
  }, [isAutoChanging, companionState])

  // éšæœºç§»åŠ¨å®šæ—¶å™¨
  useEffect(() => {
    randomMoveInterval.current = setInterval(randomMoveCompanion, 20000) // æ¯20ç§’éšæœºç§»åŠ¨ä¸€æ¬¡
    
    return () => {
      if (randomMoveInterval.current) {
        clearInterval(randomMoveInterval.current)
      }
    }
  }, [isDragging, screenSize])

  // éšæœºé¼“åŠ±å®šæ—¶å™¨
  useEffect(() => {
    const encouragementInterval = setInterval(() => {
      if (Math.random() < 0.3) { // 30%æ¦‚ç‡æ˜¾ç¤ºé¼“åŠ±
        randomEncouragement()
      }
    }, 30000) // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    
    return () => clearInterval(encouragementInterval)
  }, [])

  // åˆå§‹åŒ–
  useEffect(() => {
    console.log('ğŸš€ ä¹ä¹å¿ƒç†å¥åº·é™ªä¼´æ¡Œå® å¯åŠ¨ä¸­...')
    
    const makeVisible = async () => {
      try {
        const window = getCurrentWindow()
        await window.setAlwaysOnTop(true)
        await window.show()
        await window.setFocus()
        console.log('âœ… çª—å£å·²è®¾ç½®ä¸ºå¯è§')
        
        // æ˜¾ç¤ºæ¬¢è¿å­—å¹•
        showSubtitle({
          id: 'welcome',
          text: 'ä½ å¥½ï¼æˆ‘æ˜¯ä¹ä¹ï¼Œä½ çš„å¿ƒç†å¥åº·é™ªä¼´ä¼™ä¼´ï¼ï¿½ï¿½',
          duration: 5000,
          type: 'mental_health'
        })
      } catch (error) {
        console.error('âŒ è®¾ç½®çª—å£å¯è§æ€§å¤±è´¥:', error)
      }
    }
    
    makeVisible()
  }, [])

  // è®¡ç®—UIå…ƒç´ ä½ç½® - ä¼˜åŒ–ä¸º500x500çª—å£
  const getSubtitlePosition = () => {
    const left = Math.max(10, Math.min(position.x - 150, screenSize.width - 310))
    const top = Math.max(10, position.y - 80)
    return { left, top }
  }

  const getContextMenuPosition = () => {
    const left = Math.max(10, Math.min(position.x + 160, screenSize.width - 210))
    const top = Math.max(10, Math.min(position.y + 50, screenSize.height - 250))
    return { left, top }
  }

  const getFunctionWindowPosition = () => {
    const left = Math.max(10, Math.min(position.x - 200, screenSize.width - 410))
    const top = Math.max(10, Math.min(position.y - 200, screenSize.height - 450))
    return { left, top }
  }

  return (
    <div className="app-container">
      {/* ä¹ä¹å¿ƒç†å¥åº·é™ªä¼´äººç‰©ä¸»ä½“ */}
      <div 
        className="companion-container"
        ref={dragRef}
        style={{
          position: 'absolute',
          left: position.x,
          top: position.y,
          cursor: isDragging ? 'grabbing' : 'grab'
        }}
        onMouseDown={handleMouseDown}
        onMouseMove={handleMouseMove}
        onMouseUp={handleMouseUp}
        onMouseLeave={handleMouseUp}
        onContextMenu={handleContextMenu}
        onClick={handleClick}
      >
        <motion.img 
          src={companionStates[companionState].image}
          alt="ä¹ä¹å¿ƒç†å¥åº·é™ªä¼´ä¼™ä¼´"
          className="companion-image"
          initial={{ opacity: 0, scale: 0.5 }}
          animate={{ 
            opacity: 1, 
            scale: isAnimating ? 1.2 : 1,
            rotate: isAnimating ? [0, 10, -10, 0] : 0
          }}
          transition={{ 
            duration: isAnimating ? 0.6 : 1,
            rotate: { duration: 0.6 }
          }}
        />
        
        {/* çŠ¶æ€æŒ‡ç¤ºå™¨ */}
        <div className="state-indicator">
          {companionStates[companionState].name}
        </div>
        
        {/* å¿ƒæƒ…æŒ‡ç¤ºå™¨ */}
        <div className={`mood-indicator mood-${mood}`}>
          {mood === 'happy' && 'ğŸ˜Š'}
          {mood === 'calm' && 'ğŸ˜Œ'}
          {mood === 'anxious' && 'ğŸ˜°'}
          {mood === 'sad' && 'ğŸ˜¢'}
          {mood === 'excited' && 'ğŸ‰'}
          {mood === 'peaceful' && 'ğŸ§˜'}
        </div>

        {/* æ‹–æ‹½æç¤º */}
        <div className="drag-hint">
          æ‹–æ‹½ç§»åŠ¨
        </div>
      </div>

      {/* å­—å¹•æ˜¾ç¤º */}
      <AnimatePresence>
        {currentSubtitle && (
          <motion.div 
            className="subtitle"
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -20 }}
            style={{
              position: 'absolute',
              left: getSubtitlePosition().left,
              top: getSubtitlePosition().top,
              zIndex: 1000
            }}
          >
            <div className={`subtitle-content ${currentSubtitle.type}`}>
              {currentSubtitle.text}
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* å³é”®èœå• */}
      <AnimatePresence>
        {showContextMenu && (
          <motion.div 
            className="context-menu"
            initial={{ opacity: 0, scale: 0.8 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.8 }}
            style={{
              position: 'absolute',
              left: getContextMenuPosition().left,
              top: getContextMenuPosition().top,
              zIndex: 1001
            }}
          >
            <div className="menu-section">åŸºæœ¬è®¾ç½®</div>
            <div className="menu-item" onClick={toggleAutoChange}>
              {isAutoChanging ? 'â¸ï¸ åœæ­¢è‡ªåŠ¨é™ªä¼´' : 'â–¶ï¸ å¼€å§‹è‡ªåŠ¨é™ªä¼´'}
            </div>
            <div className="menu-item" onClick={() => setCompanionState('normal')}>
              ğŸ’š é‡ç½®çŠ¶æ€
            </div>
            
            <div className="menu-separator" />
            <div className="menu-section">å¿ƒæƒ…è®¾ç½®</div>
            <div className="menu-item" onClick={() => changeMood('happy')}>
              ğŸ˜Š å¼€å¿ƒ
            </div>
            <div className="menu-item" onClick={() => changeMood('calm')}>
              ğŸ˜Œ å¹³é™
            </div>
            <div className="menu-item" onClick={() => changeMood('anxious')}>
              ğŸ˜° ç„¦è™‘
            </div>
            <div className="menu-item" onClick={() => changeMood('sad')}>
              ğŸ˜¢ æ‚²ä¼¤
            </div>
            <div className="menu-item" onClick={() => changeMood('excited')}>
              ğŸ‰ å…´å¥‹
            </div>
            <div className="menu-item" onClick={() => changeMood('peaceful')}>
              ğŸ§˜ å¹³å’Œ
            </div>
            
            <div className="menu-separator" />
            <div className="menu-section">å¿ƒç†å¥åº·åŠŸèƒ½</div>
            {Object.entries(mentalHealthFunctions).map(([key, func]) => (
              <div 
                key={key}
                className="menu-item"
                onClick={() => openMentalHealthFunction(key as MentalHealthFunction)}
              >
                {func.icon} {func.name}
              </div>
            ))}
          </motion.div>
        )}
      </AnimatePresence>

      {/* å¿ƒç†å¥åº·åŠŸèƒ½çª—å£ */}
      <AnimatePresence>
        {showFunctionWindow && (
          <motion.div 
            className="function-window"
            initial={{ opacity: 0, scale: 0.8 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.8 }}
            style={{
              position: 'absolute',
              left: getFunctionWindowPosition().left,
              top: getFunctionWindowPosition().top,
              zIndex: 1002
            }}
          >
            <div className="function-header">
              <h3>{mentalHealthFunctions[showFunctionWindow].icon} {mentalHealthFunctions[showFunctionWindow].name}</h3>
              <button 
                className="close-btn"
                onClick={() => setShowFunctionWindow(null)}
              >
                Ã—
              </button>
            </div>
            <div className="function-content">
              <p>{mentalHealthFunctions[showFunctionWindow].description}</p>
              
              {showFunctionWindow === 'chat' ? (
                <div className="chat-interface">
                  <div className="chat-messages">
                    {chatMessages.map((message) => (
                      <div key={message.id} className={`message ${message.type}`}>
                        <div className="message-content">{message.text}</div>
                        <div className="message-time">
                          {message.timestamp.toLocaleTimeString()}
                        </div>
                      </div>
                    ))}
                  </div>
                  <div className="chat-input-container">
                    <input
                      type="text"
                      className="chat-input"
                      value={chatInput}
                      onChange={(e) => setChatInput(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && sendChatMessage()}
                      placeholder="å‘Šè¯‰æˆ‘ä½ çš„æ„Ÿå—..."
                    />
                    <button 
                      className="send-btn"
                      onClick={sendChatMessage}
                      disabled={!chatInput.trim()}
                    >
                      å‘é€
                    </button>
                  </div>
                </div>
              ) : showFunctionWindow === 'meditation' ? (
                <div className="meditation-interface">
                  <div className="meditation-guide">
                    <h4>ğŸ§˜ å†¥æƒ³å¼•å¯¼</h4>
                    <p>é€‰æ‹©ä¸€ä¸ªèˆ’é€‚çš„å§¿åŠ¿ï¼Œé—­ä¸Šçœ¼ç›ï¼Œè·Ÿéšä¹ä¹çš„å¼•å¯¼è¿›è¡Œå†¥æƒ³ã€‚</p>
                    <button className="action-btn" onClick={startMeditation}>
                      å¼€å§‹å†¥æƒ³
                    </button>
                  </div>
                </div>
              ) : showFunctionWindow === 'breathing' ? (
                <div className="breathing-interface">
                  <div className="breathing-guide">
                    <h4>ğŸŒ¬ï¸ å‘¼å¸ç»ƒä¹ </h4>
                    <p>é€šè¿‡æ·±å‘¼å¸ç»ƒä¹ æ¥æ”¾æ¾èº«å¿ƒï¼Œç¼“è§£å‹åŠ›å’Œç„¦è™‘ã€‚</p>
                    <button className="action-btn" onClick={startBreathing}>
                      å¼€å§‹å‘¼å¸ç»ƒä¹ 
                    </button>
                  </div>
                </div>
              ) : showFunctionWindow === 'mood' ? (
                <div className="mood-interface">
                  <div className="mood-tracker">
                    <h4>ğŸ˜Š å¿ƒæƒ…è®°å½•</h4>
                    <p>è®°å½•ä½ å½“å‰çš„å¿ƒæƒ…çŠ¶æ€ï¼Œå¸®åŠ©äº†è§£è‡ªå·±çš„æƒ…ç»ªå˜åŒ–ã€‚</p>
                    <div className="mood-options">
                      {['anxious', 'sad', 'stressed', 'lonely', 'overwhelmed', 'okay'].map((moodType) => (
                        <button 
                          key={moodType}
                          className={`mood-btn ${currentMood === moodType ? 'active' : ''}`}
                          onClick={() => setCurrentMood(moodType as any)}
                        >
                          {moodType === 'anxious' && 'ğŸ˜° ç„¦è™‘'}
                          {moodType === 'sad' && 'ğŸ˜¢ æ‚²ä¼¤'}
                          {moodType === 'stressed' && 'ğŸ˜¤ å‹åŠ›'}
                          {moodType === 'lonely' && 'ğŸ˜” å­¤ç‹¬'}
                          {moodType === 'overwhelmed' && 'ğŸ˜µ ä¸çŸ¥æ‰€æª'}
                          {moodType === 'okay' && 'ğŸ˜Œ è¿˜å¥½'}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
              ) : (
                <div className="function-placeholder">
                  <p>ğŸš§ åŠŸèƒ½å¼€å‘ä¸­...</p>
                  <p>è¿™é‡Œå°†é›†æˆæ›´å¤šå¿ƒç†å¥åº·åŠŸèƒ½</p>
                  <p>åŒ…æ‹¬æƒ…ç»ªæ—¥è®°ã€å¥åº·æé†’ã€æ²»æ„ˆéŸ³ä¹ç­‰</p>
                  <div className="integration-status">
                    <div className="status-item">
                      <span className="status-icon">ğŸ’š</span>
                      <span>å¿ƒç†å¥åº·é™ªä¼´</span>
                      <span className="status-badge">å·²é›†æˆ</span>
                    </div>
                    <div className="status-item">
                      <span className="status-icon">ğŸ§˜</span>
                      <span>å†¥æƒ³å¼•å¯¼</span>
                      <span className="status-badge">å·²é›†æˆ</span>
                    </div>
                    <div className="status-item">
                      <span className="status-icon">ğŸŒ¬ï¸</span>
                      <span>å‘¼å¸ç»ƒä¹ </span>
                      <span className="status-badge">å·²é›†æˆ</span>
                    </div>
                    <div className="status-item">
                      <span className="status-icon">ğŸ“</span>
                      <span>æƒ…ç»ªæ—¥è®°</span>
                      <span className="status-badge">å¼€å‘ä¸­</span>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  )
}

export default App
